import SwiftUI
import AVFoundation

struct ConversationPracticeView: View {
    @EnvironmentObject private var authManager: AuthenticationManager
    @Environment(\.dismiss) private var dismiss

    @StateObject private var conversationService = ConversationService()
    @StateObject private var elevenLabsService = ElevenLabsService.shared

    @State private var messageText = ""
    @State private var isListening = false
    @State private var isProcessing = false
    @State private var hasFinalized = false
    @State private var conversationStart = Date()

    @State private var currentScenario = ScenarioPalette.socialGreeting
    @Namespace private var scenarioNamespace

    private var availableScenarios: [ScenarioPalette] { ScenarioPalette.allCases }

    var body: some View {
        NavigationStack {
            ZStack(alignment: .top) {
                AuraBackground()

                VStack(spacing: 20) {
                    header
                    conversationTranscript
                    quickResponses
                    inputBar
                    footerStats
                }
                .padding(.horizontal, 22)
                .padding(.top, 24)
                .padding(.bottom, 26)
            }
            .navigationBarHidden(true)
        }
        .onAppear { startConversation(with: currentScenario.scenario) }
        .onDisappear { finishConversation() }
        .onChange(of: currentScenario) { _, newValue in
            restartConversation(with: newValue.scenario)
        }
        .onReceive(conversationService.$isListening) { listen in
            isListening = listen
        }
    }
}

// MARK: - Layout Sections
private extension ConversationPracticeView {
    var header: some View {
        GlassCard {
            VStack(alignment: .leading, spacing: 18) {
                HStack(alignment: .top) {
                    VStack(alignment: .leading, spacing: 6) {
                        Text("Conversation Practice")
                            .font(.title3.weight(.bold))
                            .foregroundStyle(.white)
                        Text("Build social confidence through guided chat scenarios")
                            .font(.footnote)
                            .foregroundStyle(.white.opacity(0.7))
                    }
                    Spacer()
                    GlassButton(style: .secondary) {
                        finishConversation()
                        dismiss()
                    } label: {
                        Label("Exit", systemImage: "xmark")
                    }
                    .controlSize(.small)
                }

                scenarioSelector
            }
        }
    }

    var scenarioSelector: some View {
        ScrollView(.horizontal, showsIndicators: false) {
            HStack(spacing: 16) {
                ForEach(availableScenarios) { palette in
                    scenarioChip(for: palette)
                }
            }
            .padding(.vertical, 6)
        }
    }

    func scenarioChip(for palette: ScenarioPalette) -> some View {
        let isSelected = currentScenario == palette
        return Button {
            currentScenario = palette
        } label: {
            VStack(alignment: .leading, spacing: 6) {
                HStack(spacing: 8) {
                    Image(systemName: palette.icon)
                    Text(palette.title)
                        .fontWeight(.semibold)
                }
                Text(palette.subtitle)
                    .font(.caption)
                    .foregroundStyle(.white.opacity(0.7))
                CapabilityBadge(level: palette.scenario.difficulty)
            }
            .padding(.horizontal, 18)
            .padding(.vertical, 14)
            .frame(minWidth: 180, alignment: .leading)
            .background(
                RoundedRectangle(cornerRadius: 22, style: .continuous)
                    .fill(LinearGradient(colors: palette.colors.map { $0.opacity(isSelected ? 0.65 : 0.35) }, startPoint: .topLeading, endPoint: .bottomTrailing))
                    .overlay(
                        RoundedRectangle(cornerRadius: 22, style: .continuous)
                            .stroke(Color.white.opacity(isSelected ? 0.4 : 0.2), lineWidth: 1)
                    )
            )
            .matchedGeometryEffect(id: palette.id, in: scenarioNamespace)
            .foregroundStyle(.white)
        }
        .buttonStyle(.plain)
    }

    var conversationTranscript: some View {
        GlassCard(cornerRadius: 26, padding: 0) {
            ScrollViewReader { proxy in
                ScrollView {
                    LazyVStack(spacing: 16) {
                        ForEach(conversationService.conversationHistory) { message in
                            MessageBubble(message: message)
                                .id(message.id)
                                .padding(.horizontal, 18)
                        }

                        if isProcessing {
                            TypingIndicator()
                                .padding(.horizontal, 18)
                        }
                    }
                    .padding(.vertical, 22)
                }
                .background(
                    RoundedRectangle(cornerRadius: 26, style: .continuous)
                        .fill(Color.white.opacity(0.04))
                )
                .onChange(of: conversationService.conversationHistory.count) { _, _ in
                    guard let last = conversationService.conversationHistory.last else { return }
                    withAnimation(.easeInOut(duration: 0.3)) {
                        proxy.scrollTo(last.id, anchor: .bottom)
                    }
                }
            }
        }
    }

    var quickResponses: some View {
        GlassCard(padding: 16) {
            VStack(alignment: .leading, spacing: 12) {
                HStack {
                    Label("Quick prompts", systemImage: "sparkles")
                        .font(.headline)
                        .foregroundStyle(.white)
                    Spacer()
                    Text("Tap to respond or adapt")
                        .font(.caption)
                        .foregroundStyle(.white.opacity(0.65))
                }

                ScrollView(.horizontal, showsIndicators: false) {
                    HStack(spacing: 12) {
                        ForEach(currentScenario.quickResponses, id: \.self) { response in
                            GlassButton(style: .secondary) {
                                sendMessage(response)
                            } label: {
                                Text(response)
                                    .font(.subheadline)
                                    .padding(.horizontal, 6)
                            }
                            .controlSize(.small)
                        }
                    }
                }
            }
        }
    }

    var inputBar: some View {
        GlassCard(padding: 16) {
            VStack(alignment: .leading, spacing: 12) {
                Text("Write or speak your response")
                    .font(.caption)
                    .foregroundStyle(.white.opacity(0.7))

                HStack(spacing: 12) {
                    TextField("Type your messageâ€¦", text: $messageText)
                        .textFieldStyle(.plain)
                        .padding(.horizontal, 14)
                        .padding(.vertical, 12)
                        .background(
                            RoundedRectangle(cornerRadius: 18, style: .continuous)
                                .fill(Color.white.opacity(0.07))
                                .overlay(
                                    RoundedRectangle(cornerRadius: 18, style: .continuous)
                                        .stroke(Color.white.opacity(0.18), lineWidth: 1)
                                )
                        )

                    GlassButton(style: .primary) {
                        let trimmed = messageText.trimmingCharacters(in: .whitespacesAndNewlines)
                        guard !trimmed.isEmpty else { return }
                        sendMessage(trimmed)
                        messageText = ""
                    } label: {
                        Image(systemName: "paperplane.fill")
                            .font(.title3)
                    }
                    .disabled(messageText.trimmingCharacters(in: .whitespacesAndNewlines).isEmpty)

                    GlassButton(style: isListening ? .danger : .primary) {
                        toggleListening()
                    } label: {
                        Image(systemName: isListening ? "mic.fill" : "mic")
                            .font(.title3)
                            .symbolEffect(.bounce, value: isListening)
                    }
                }
            }
        }
    }

    var footerStats: some View {
        GlassCard(cornerRadius: 28, padding: 0) {
            HStack(spacing: 20) {
                FooterMetric(icon: "clock", title: "Duration", value: formattedDuration)
                Divider().overlay(Color.white.opacity(0.18))
                FooterMetric(icon: "hand.thumbsup", title: "Positivity", value: positivityScore)
                Divider().overlay(Color.white.opacity(0.18))
                FooterMetric(icon: "star", title: "Progress", value: currentScenario.goalKeyword)
            }
            .padding(.vertical, 16)
        }
    }
}

// MARK: - Interaction
private extension ConversationPracticeView {
    func startConversation(with scenario: ConversationScenario) {
        messageText = ""
        isProcessing = false
        conversationStart = Date()
        hasFinalized = false
        conversationService.conversationHistory.removeAll()

        Task {
            do {
                try await conversationService.startConversation(
                    scenario: scenario,
                    userLevel: UserLevel(level: authManager.currentProgress.currentLevel, description: "User level")
                )
                if let welcome = conversationService.conversationHistory.last?.content {
                    try await elevenLabsService.playConversationResponse(welcome, tone: .supportive)
                }
            } catch {
                await MainActor.run {
                    appendSystemMessage("I'm having trouble starting right now. Let's try again in a moment.")
                }
            }
        }
    }

    func restartConversation(with scenario: ConversationScenario) {
        finishConversation()
        startConversation(with: scenario)
    }

    func sendMessage(_ text: String) {
        let trimmed = text.trimmingCharacters(in: .whitespacesAndNewlines)
        guard !trimmed.isEmpty else { return }
        isProcessing = true

        Task {
            _ = await conversationService.processUserMessage(trimmed)
            await MainActor.run { isProcessing = false }
        }
    }

    func toggleListening() {
        if isListening {
            conversationService.stopListening()
            isListening = false
        } else {
            Task {
                do {
                    try await conversationService.startListening()
                    await MainActor.run { isListening = true }
                } catch {
                    await MainActor.run {
                        isListening = false
                        appendSystemMessage("I couldn't access the microphone. Try again later.")
                    }
                }
            }
        }
    }

    func finishConversation() {
        guard !hasFinalized else { return }
        hasFinalized = true
        conversationService.endConversation()

        Task {
            var summaryText: String?
            for _ in 0..<6 {
                try? await Task.sleep(nanoseconds: 400_000_000)
                if let summary = conversationService.currentConversation?.summary, !summary.isEmpty {
                    summaryText = summary
                    break
                }
            }

            let highlights = summaryText ?? fallbackHighlight()
            let recommendations = "Practice \(currentScenario.title.lowercased()) again and focus on \(currentScenario.goal.lowercased())."
            let duration = conversationService.currentConversation?.duration ?? Date().timeIntervalSince(conversationStart)

            let summary = ConversationSummary(
                date: Date(),
                scenarioTitle: currentScenario.title,
                duration: duration,
                highlights: highlights,
                recommendations: recommendations
            )

            await MainActor.run {
                authManager.recordConversation(summary)
            }
        }
    }

    func fallbackHighlight() -> String {
        if let lastAssistant = conversationService.conversationHistory.last(where: { $0.sender == .assistant }) {
            return lastAssistant.content
        }
        return "Great effort in practicing conversations today!"
    }

    func appendSystemMessage(_ text: String) {
        let message = ConversationMessage(
            id: UUID(),
            content: text,
            sender: .assistant,
            timestamp: Date(),
            emotionalTone: .supportive
        )
        conversationService.conversationHistory.append(message)
    }

    var formattedDuration: String {
        let interval = Date().timeIntervalSince(conversationStart)
        let minutes = Int(interval) / 60
        let seconds = Int(interval) % 60
        return String(format: "%02dm %02ds", minutes, seconds)
    }

    var positivityScore: String {
        let positives = conversationService.conversationHistory.filter { $0.emotionalTone == .supportive }.count
        let total = max(conversationService.conversationHistory.count, 1)
        let percentage = Int(Double(positives) / Double(total) * 100)
        return "\(percentage)%"
    }
}

